name: Deploy Auth Backend

on:
  push:
    branches: [ main ]
    paths:
      - 'rn-auth-backend/**'
      - '.github/workflows/deploy-auth-backend.yml'  # Temporarily enabled for testing
  workflow_dispatch:

jobs:
  setup-server:
    name: Setup Auth Server Environment
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Verify repository structure
      run: |
        echo "ğŸ” Repository structure:"
        ls -la
        echo "ğŸ” Auth Backend directory contents:"
        ls -la rn-auth-backend/
        echo "ğŸ” Checking if install.sh exists..."
        if [ -f "rn-auth-backend/install.sh" ]; then
          echo "âœ… install.sh found"
        else
          echo "âŒ install.sh not found"
          exit 1
        fi

    - name: Check if server is already set up
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          echo "ğŸ” Checking if server is already set up..."
          
          # Check if Node.js and Caddy are installed
          if command -v node &> /dev/null && command -v npm &> /dev/null && command -v caddy &> /dev/null; then
            echo "âœ… Server is already set up!"
            echo "Node.js: $(node --version)"
            echo "npm: $(npm --version)"
            echo "Caddy: $(caddy version)"
            
            # Clean up any PM2 processes if they exist
            if command -v pm2 &> /dev/null; then
              echo "âš ï¸ Cleaning up old PM2 process..."
              pm2 delete auth-backend 2>/dev/null || true
              pm2 save --force 2>/dev/null || true
            fi
            
            echo "âœ… Server setup complete - skipping installation"
            exit 0
          else
            echo "âŒ Server not set up - proceeding with installation"
            exit 1
          fi

    - name: Upload and run installation script
      if: failure()
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        source: "install-server.sh"
        target: "/home/${{ secrets.SERVER_USER }}/install-server.sh"

    - name: Run server setup script
      if: failure()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          chmod +x ~/install-server.sh
          ~/install-server.sh auth

  deploy-app:
    name: Deploy Auth Backend Application
    runs-on: ubuntu-latest
    needs: setup-server
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create deployment package
      run: |
        # Create .env file in rn-auth-backend directory
        cat > rn-auth-backend/.env << EOF
        MONGODB_URI=${{ secrets.MONGODB_URI }}
        PORT=5000
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        NODE_ENV=production
        EOF

        # Create logs directory
        mkdir -p rn-auth-backend/logs
        
        # Remove PM2 config (not needed with systemd)
        rm -f rn-auth-backend/ecosystem.config.cjs

        # Create tarball of entire rn-auth-backend directory
        tar -czf auth-backend.tar.gz rn-auth-backend/

    - name: Upload deployment package
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        source: "auth-backend.tar.gz"
        target: "/tmp/"

    - name: Extract and deploy application
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          echo "ğŸ“ Creating backend directory..."
          mkdir -p ~/school-project/backend
          cd ~/school-project/backend
          
          echo "ğŸ“¦ Extracting deployment package..."
          tar -xzf /tmp/auth-backend.tar.gz
          rm /tmp/auth-backend.tar.gz
          
          echo "ğŸ“‹ Directory structure:"
          ls -la
          
          echo "ğŸ“‚ Entering rn-auth-backend..."
          cd rn-auth-backend
          
          echo "ğŸ“‹ Application files:"
          ls -la
          
          echo "ğŸ“‹ Checking key files..."
          if [ -f "server.js" ]; then
            echo "âœ… server.js found"
          else
            echo "âŒ server.js NOT found!"
            exit 1
          fi
          
          if [ -f ".env" ]; then
            echo "âœ… .env found"
          else
            echo "âŒ .env NOT found!"
            exit 1
          fi

          echo "ğŸ“¦ Installing production dependencies..."
          npm install --production

          echo "ğŸ” Verifying environment variables..."
          echo "MONGODB_URI: ${MONGODB_URI:0:20}..."
          echo "JWT_SECRET: ${JWT_SECRET:0:10}..."

          echo "ğŸ”„ Creating systemd service..."
          
          # Get current user and home directory
          CURRENT_USER=$(whoami)
          HOME_DIR=$(eval echo ~$CURRENT_USER)
          
          # Create systemd service file
          sudo tee /etc/systemd/system/auth-backend.service << EOF
          [Unit]
          Description=Auth Backend Node.js Server
          After=network.target

          [Service]
          ExecStart=/usr/bin/node ${HOME_DIR}/school-project/backend/rn-auth-backend/server.js
          Restart=always
          RestartSec=5
          User=${CURRENT_USER}
          EnvironmentFile=${HOME_DIR}/school-project/backend/rn-auth-backend/.env
          WorkingDirectory=${HOME_DIR}/school-project/backend/rn-auth-backend
          StandardOutput=append:${HOME_DIR}/school-project/backend/rn-auth-backend/logs/out.log
          StandardError=append:${HOME_DIR}/school-project/backend/rn-auth-backend/logs/err.log

          [Install]
          WantedBy=multi-user.target
          EOF

          echo "ğŸ“‹ Generated systemd service file:"
          cat /etc/systemd/system/auth-backend.service

          echo "ğŸ”„ Reloading systemd and restarting service..."
          sudo systemctl daemon-reload
          sudo systemctl enable auth-backend
          sudo systemctl restart auth-backend
          
          echo "â³ Waiting for service to start..."
          sleep 5
          
          echo "âœ… Deployment completed successfully!"
          
          echo "ğŸ“Š Service status:"
          sudo systemctl status auth-backend --no-pager

    - name: Health check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          cd ~/school-project/backend/rn-auth-backend
          
          echo "ğŸ” Checking .env file..."
          if [ -f ".env" ]; then
            echo "âœ… .env exists"
            echo "Environment variables (masked):"
            cat .env | sed 's/=.*/=***MASKED***/g'
          else
            echo "âŒ .env missing!"
          fi
          
          echo ""
          echo "ğŸ” Waiting for application to start..."
          sleep 10
          
          echo ""
          echo "ğŸ“Š Systemd Service Status:"
          sudo systemctl status auth-backend --no-pager
          
          echo ""
          echo "ğŸ“ Error Logs (last 50 lines):"
          cat logs/err.log | tail -50 || echo "No error log"
          
          echo ""
          echo "ğŸ“ Output Logs (last 50 lines):"
          cat logs/out.log | tail -50 || echo "No output log"
          
          echo ""
          echo "ğŸ“ Systemd Journal (last 30 lines):"
          sudo journalctl -u auth-backend -n 30 --no-pager
          
          echo ""
          # Check if service is active
          if sudo systemctl is-active --quiet auth-backend; then
            echo "âœ… Service is running"
          else
            echo "âŒ Service is not running"
            exit 1
          fi
          
          # Check if API is responding
          if curl -f -s http://localhost:5000/api/health > /dev/null; then
            echo "âœ… API is responding"
            curl -s http://localhost:5000/api/health | jq '.'
          else
            echo "âŒ API not responding"
            echo "Check logs above for the error"
            exit 1
          fi

    - name: Deployment Summary
      if: always()
      run: |
        echo "ğŸ“Š Deployment Summary"
        echo "===================="
        echo "ğŸŒ Domain: https://auth.ekowlabs.space"
        echo "ğŸ“ API Base: https://auth.ekowlabs.space/api"
        echo "ğŸ“š API Docs: https://auth.ekowlabs.space/api-docs"
        echo ""
        echo "ğŸ”— Endpoints:"
        echo "  â€¢ POST /api/auth/register - Register new user"
        echo "  â€¢ POST /api/auth/login - Login user"
        echo "  â€¢ GET /api/profile - Get user profile (requires auth)"
        echo "  â€¢ GET /api/health - Health check"
        echo ""
        echo "ğŸ”§ Service Management:"
        echo "  â€¢ sudo systemctl status auth-backend - Check status"
        echo "  â€¢ sudo systemctl restart auth-backend - Restart service"
        echo "  â€¢ sudo systemctl stop auth-backend - Stop service"
        echo "  â€¢ sudo journalctl -u auth-backend -f - View logs"

